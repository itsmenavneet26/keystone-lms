import{z as ce,T as Z,d as Y,L as ae,a as m,b as e,e as $,w as A,p as W,N as pe,F as K,r as Q,l as P,f as O,fc as xe,B as E,E as R,o as t,k as X,bx as G,t as D,u as q,aj as we,a2 as ne,Q as Se,q as fe,n as H,y as ve,aX as le,br as $e,fd as Ce,am as me,ao as Ie,s as Me,c as _e,v as Fe,fe as Ve,bf as ye,ca as Ee,eW as Te,Z as Ne,ff as De,W as Ue,aF as be,x as Re,A as Le,i as je}from"./index-H4DTv6Le.js";import{_ as Oe}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-CKfttt8M.js";import{T as Pe}from"./TabButtons-BM55rf33.js";const re=h=>({Pending:"orange",Success:"green","Partial Success":"orange",Error:"red","Timed Out":"orange"})[h]||"gray",oe=["Section Break","Column Break","Tab Break","HTML","Table","Table MultiSelect","Button","Image","Fold","Heading"],he=(h,T,i)=>{let a="";return i.filter(g=>g.name==T)[0].fields.forEach(g=>{g.options==h&&(a=g.fieldname)}),a},ke=(h,T,i)=>ce("frappe.core.doctype.data_import.data_import.get_preview_from_template",{data_import:h,import_file:T,google_sheets_url:i}).catch(a=>{var r;Z.error(((r=a.messages)==null?void 0:r[0])||a),console.error("Error fetching preview data:",a)}),ze={class:"flex min-h-0 flex-col text-base py-5 w-[90%] lg:w-[700px] mx-auto"},Be={class:"flex items-center justify-between"},qe={class:"flex items-center space-x-2 my-5"},Ae={key:0,class:"overflow-y-scroll"},Je={class:"divide-y"},He=["onClick"],We={class:"space-y-1"},Ge={class:"text-ink-gray-7"},Ke={class:"text-ink-gray-5"},Qe={class:"my-5 flex justify-center"},Xe={key:1,class:"text-sm italic text-ink-gray-5 mt-5"},Ze=Y({__name:"DataImportList",props:{dataImports:{}},emits:["updateStep"],setup(h,{emit:T}){const i=E(""),a=E("All"),r=E(!1),g=E(null),u=fe(),x=h,U=R(()=>["All","Pending","Success","Partial Success","Error","Timed Out"].map(s=>({label:s,value:s})));ae([i,a],([b,s])=>{x.dataImports.update({filters:[b?[["name","like",`%${b}%`]]:[],s!=="All"?[["status","=",s]]:[]].flat()}),x.dataImports.reload()});const L=b=>{x.dataImports.insert.submit({reference_doctype:g.value,import_type:"Insert New Records",mute_emails:!0,status:"Pending"},{onSuccess(s){u.replace({name:"DataImport",params:{importName:s.name}}),b()},onError(s){var f;console.error(s),Z.error(((f=s.messages)==null?void 0:f[0])||s)}})},z=b=>{u.replace({name:"DataImport",params:{importName:b}})};return(b,s)=>{var f;return t(),m("div",ze,[e("div",Be,[s[7]||(s[7]=e("div",null,[e("div",{class:"text-xl font-semibold mb-1 text-ink-gray-9"}," Data Import "),e("div",{class:"text-ink-gray-6 leading-5"}," Import data into your system using CSV files. ")],-1)),$(W,{variant:"solid",onClick:s[0]||(s[0]=d=>r.value=!0)},{prefix:A(()=>[$(G,{name:"plus",class:"size-4 stroke-1.5"})]),default:A(()=>[s[6]||(s[6]=X(" Import ",-1))]),_:1})]),e("div",qe,[$(pe,{modelValue:i.value,"onUpdate:modelValue":s[1]||(s[1]=d=>i.value=d),placeholder:"Search imported files",type:"text",class:"flex-1"},null,8,["modelValue"]),$(pe,{modelValue:a.value,"onUpdate:modelValue":s[2]||(s[2]=d=>a.value=d),type:"select",options:U.value},null,8,["modelValue","options"])]),(f=h.dataImports.data)!=null&&f.length?(t(),m("div",Ae,[e("div",Je,[s[8]||(s[8]=e("div",{class:"grid grid-cols-[75%,20%] lg:grid-cols-[85%,20%] items-center text-sm text-ink-gray-5 py-1.5 mx-2 my-0.5 px-1"},[e("div",null," Name "),e("div",{class:"pl-1"}," Status ")],-1)),(t(!0),m(K,null,Q(h.dataImports.data,d=>(t(),m("div",{onClick:()=>z(d.name),class:"grid grid-cols-[75%,20%] lg:grid-cols-[85%,20%] items-center cursor-pointer py-2.5 px-1 mx-2"},[e("div",We,[e("div",Ge,D(d.reference_doctype),1),e("div",Ke,D(q(we)(d.creation).fromNow()),1)]),$(ne,{label:d.status,theme:q(re)(d.status),class:"w-fit"},null,8,["label","theme"])],8,He))),256))]),e("div",Qe,[x.dataImports.hasNextPage?(t(),P(W,{key:0,onClick:s[3]||(s[3]=d=>x.dataImports.next())},{prefix:A(()=>[$(G,{name:"refresh-cw",class:"size-4 stroke-1.5"})]),default:A(()=>[s[9]||(s[9]=X(" Load More ",-1))]),_:1})):O("",!0)])])):(t(),m("div",Xe," No data imports found. ")),$(xe,{modelValue:r.value,"onUpdate:modelValue":s[5]||(s[5]=d=>r.value=d),options:{title:"New Data Import",actions:[{label:"Continue",variant:"solid",onClick({close:d}){L(d)}}]}},{"body-content":A(()=>[e("div",null,[$(Se,{modelValue:g.value,"onUpdate:modelValue":s[4]||(s[4]=d=>g.value=d),doctype:"DocType",filters:{allow_import:1},label:"Choose a Document Type to import"},null,8,["modelValue"])])]),_:1},8,["modelValue","options"])])}}}),Ye={class:"flex items-center space-x-3 lg:space-x-10 text-xs lg:text-base"},ge=Y({__name:"ImportSteps",props:{data:{},step:{}},emits:["updateStep"],setup(h,{emit:T}){const i=T,a=h,r=R(()=>a.step==="upload"),g=R(()=>{var s,f;return((s=a.data)==null?void 0:s.import_file)||((f=a.data)==null?void 0:f.google_sheets_url)}),u=R(()=>a.step==="map"),x=R(()=>{var s;return a.data&&((s=a.data)==null?void 0:s.template_options)&&JSON.parse(a.data.template_options).column_to_field_map}),U=R(()=>a.step==="preview"),L=R(()=>{var s;return((s=a.data)==null?void 0:s.status)==="Success"}),z=()=>{g.value&&i("updateStep","map",{...a.data})},b=()=>{g.value&&i("updateStep","preview",{...a.data})};return(s,f)=>(t(),m("div",Ye,[e("div",{class:H(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5 cursor-pointer",{"text-ink-gray-9 font-semibold":r.value}]),onClick:f[0]||(f[0]=d=>i("updateStep","upload",{...h.data}))},[g.value?(t(),P(G,{key:0,name:"check",class:H(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":r.value}])},null,8,["class"])):(t(),m("div",{key:1,class:H(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":r.value}])},[...f[3]||(f[3]=[e("span",null," 1 ",-1)])],2)),f[4]||(f[4]=e("div",null," Upload File ",-1))],2),e("div",{class:H(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5",{"text-ink-gray-9 font-semibold":u.value,"cursor-pointer":g.value}]),onClick:f[1]||(f[1]=d=>z())},[x.value?(t(),P(G,{key:0,name:"check",class:H(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":u.value}])},null,8,["class"])):(t(),m("div",{key:1,class:H(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":u.value}])},[...f[5]||(f[5]=[e("span",null," 2 ",-1)])],2)),f[6]||(f[6]=e("div",null," Map Data ",-1))],2),e("div",{class:H(["flex items-center space-x-1 lg:space-x-2 text-ink-gray-5",{"text-ink-gray-9 font-semibold":U.value,"cursor-pointer":g.value}]),onClick:f[2]||(f[2]=d=>b())},[L.value?(t(),P(G,{key:0,name:"check",class:H(["size-5 text-sm border rounded-[5px] p-0.5",{"text-ink-white bg-surface-gray-7":U.value}])},null,8,["class"])):(t(),m("div",{key:1,class:H(["text-sm border rounded-[5px] px-1.5 py-0.5",{"text-ink-white bg-surface-gray-7":U.value}])},[...f[7]||(f[7]=[e("span",null," 3 ",-1)])],2)),f[8]||(f[8]=e("div",null," Review & Import ",-1))],2)]))}}),et={class:"w-[85%] lg:w-[700px] mx-auto py-12 space-y-8 text-base"},tt={class:"flex justify-between"},at={class:"space-y-2"},st={class:"text-lg font-semibold text-ink-gray-9"},lt={class:"flex flex-col lg:flex-row space-y-2 lg:space-x-2 lg:space-y-0"},ot={key:0,class:"border rounded-md space-y-8"},nt={class:"grid grid-cols-2 py-2 px-4 gap-y-8"},rt={class:"text-ink-gray-7"},it=Y({__name:"MappingStep",props:{dataImports:{},data:{},fields:{}},emits:["updateStep"],setup(h,{emit:T}){const i=E(null),a=T,r=E({}),g=E(!1),u=h;ve(async()=>{i.value=await ke(u.data.name,u.data.import_file,u.data.google_sheets_url),x()});const x=()=>{var F,C,M;const d={};let l=[];(F=u.data)!=null&&F.template_options&&(l=(M=JSON.parse((C=u.data)==null?void 0:C.template_options))==null?void 0:M.column_to_field_map),Object.keys(l).length>0&&(g.value=!0),z.value.forEach((p,o)=>{l&&l[o]?d[p]=U(l[o]):d[p]=p}),r.value=d},U=d=>{const l=b.value.find(F=>F.value==d);return l?l.label:d},L=(d,l)=>{var M,p;if(!l)return;g.value=!0;let F=(M=u.data)!=null&&M.template_options?JSON.parse((p=u.data)==null?void 0:p.template_options):{},C=F.column_to_field_map||{};C[d-1]=l.value,u.dataImports.setValue.submit({...u.data,template_options:JSON.stringify({...F,column_to_field_map:C})},{onSuccess:o=>{a("updateStep","map",{...o}),le(()=>{x()})},onError:o=>{var k;Z.error(((k=o.messages)==null?void 0:k[0])||o),console.error("Error updating column mappings:",o)}})},z=R(()=>{var l;const d=[];return(l=i.value)==null||l.columns.forEach(F=>{F.header_title!="Sr. No"&&d.push(F.header_title)}),d}),b=R(()=>{var F;const d=u.data.reference_doctype;return(((F=u.fields.data)==null?void 0:F.docs)||[]).map(C=>{const M=C.name===d,p=C.fields.filter(o=>!oe.includes(o.fieldtype)).map(o=>({value:o.fieldname,label:M?o.label:`${o.label} (${f(d,C.name)})`}));return[{value:"name",label:"ID"},...p]}).flat()}),s=()=>{var l,F;let d=(l=u.data)!=null&&l.template_options?JSON.parse((F=u.data)==null?void 0:F.template_options):{};u.dataImports.setValue.submit({...u.data,template_options:JSON.stringify({...d,column_to_field_map:{}})},{onSuccess:C=>{a("updateStep","map",{...C}),le(()=>{x()})},onError:C=>{var M;Z.error(((M=C.messages)==null?void 0:M[0])||C),console.error("Error resetting column mappings:",C)}})},f=(d,l)=>{var M,p;let C=(((p=(M=u.fields.data)==null?void 0:M.docs.find(o=>o.name==d))==null?void 0:p.fields)||[]).filter(o=>o.options==l)[0];return(C==null?void 0:C.label)||l};return(d,l)=>{var F,C;return t(),m("div",et,[e("div",tt,[e("div",at,[e("div",st,[l[1]||(l[1]=e("span",null," Map Data ",-1)),(F=h.data)!=null&&F.status?(t(),P(ne,{key:0,theme:q(re)((C=h.data)==null?void 0:C.status)},{default:A(()=>{var M;return[X(D((M=h.data)==null?void 0:M.status),1)]}),_:1},8,["theme"])):O("",!0)]),l[2]||(l[2]=e("div",{class:"leading-5 text-ink-gray-7"}," Change the mapping of columns from your file to fields in the system ",-1))]),e("div",lt,[g.value?(t(),P(W,{key:0,label:"Reset Mapping",onClick:s})):O("",!0),$(W,{label:"Continue",variant:"solid",onClick:l[0]||(l[0]=M=>d.$emit("updateStep","preview"))})])]),Object.keys(r.value).length?(t(),m("div",ot,[l[3]||(l[3]=e("div",{class:"grid grid-cols-2 text-ink-gray-5 border-b py-2 px-4"},[e("div",null," Fields in File "),e("div",null," Fields in System ")],-1)),e("div",nt,[(t(!0),m(K,null,Q(z.value.length,M=>(t(),m(K,{key:M},[e("div",rt,D(z.value[M-1]),1),$($e,{"model-value":r.value[z.value[M-1]],options:b.value,placeholder:"Select field","onUpdate:modelValue":p=>L(M,p)},null,8,["model-value","options","onUpdate:modelValue"])],64))),128))])])):O("",!0)])}}}),dt={class:"text-base h-full flex flex-col w-[90%] lg:w-[700px] mx-auto py-12 space-y-10"},ut={class:"flex flex-col space-y-1"},ct={class:"flex items-center justify-between text-ink-gray-7"},pt={class:"flex items-center space-x-2 text-lg font-semibold text-ink-gray-9"},mt={key:0,class:"space-y-2"},ft={class:"border rounded-md bg-surface-gray-2 p-4 space-y-4 text-sm text-ink-gray-7"},vt={class:"grid grid-cols-[40%,10%,40%] lg:grid-cols-3 space-x-3 items-center"},yt={class:""},gt={class:"flex justify-end"},xt={key:1,class:"space-y-2"},_t={class:"rounded-md bg-surface-amber-2 p-2 space-y-2 text-xs"},bt={class:"flex items-center space-x-2"},ht=["innerHTML"],kt={key:2,class:"border rounded-md overflow-x-auto"},wt={class:"divide-y"},St={class:"rounded-t-md"},$t={class:"bg-surface-white divide-y divide-surface-gray-2"},Ct={class:"leading-5 text-sm"},It={key:3,class:"space-y-4"},Mt={key:0,class:"border rounded-md overflow-x-auto"},Ft={class:"table-fixed w-full divide-y"},Vt={class:"bg-surface-white divide-y divide-surface-gray-2"},Et={class:"px-3 py-2 text-sm text-ink-gray-7 border-r"},Tt={class:"flex items-center justify-center space-x-2"},Nt={key:0,class:"size-1.5 bg-surface-green-3 rounded"},Dt={key:1,class:"size-1.5 bg-surface-red-5 rounded"},Ut={class:"px-3 py-2 text-sm text-ink-gray-7 w-full"},Rt=["innerHTML"],Lt={key:1},jt={key:2},Ot=["onClick"],Pt={class:"px-3 py-2 text-ink-gray-5 float-right invisible group-hover:visible"},zt={class:"w-[500px] p-2 text-xs leading-5 font-mono"},Bt={key:1,class:"text-ink-gray-5 text-sm"},qt=Y({__name:"PreviewStep",props:{dataImports:{},data:{},fields:{},doctypeMap:{}},emits:["updateStep"],setup(h,{emit:T}){const i=E(null),a=T,r=E([]),g=E([]),u=E("all"),x=h;ve(async()=>{var v;Ce().on("data_import_refresh",w=>{U(w.data_import)}),(v=x.data)!=null&&v.name&&(i.value=await ke(x.data.name,x.data.import_file,x.data.google_sheets_url),x.data.status!="Pending"&&d())});const U=y=>{y==x.data.name&&le(()=>{x.dataImports.reload(),le(async()=>{var w;let v=(w=x.dataImports.data)==null?void 0:w.find(B=>B.name===x.data.name);a("updateStep","preview",{...v}),d()})})},L=R(()=>{var v;const y=[];return(v=i.value)==null||v.columns.forEach((w,B)=>{let _="left",j="300px";B==0?(w.header_title="No",_="center",j="60px"):w.header_title=="ID"&&(j="150px"),y.push({key:w.header_title,label:w.header_title,width:j,align:_})}),y}),z=R(()=>{var v;const y=[];return(v=i.value)==null||v.data.forEach(w=>{const B={};Object.keys(w).forEach((_,j)=>{let c=b(j),n=s(j);c=="No"?B[c]=w[_]-1:n?B[c]=w[n]:B[c]=w[_]}),y.push(B)}),y}),b=y=>{var v,w;return((w=(v=i.value)==null?void 0:v.columns[y])==null?void 0:w.header_title)||`Column ${y+1}`},s=y=>{var _,j,c,n,V,S,N;if(!((j=(_=i.value)==null?void 0:_.columns[y])==null?void 0:j.map_to_field))return null;let w=(V=(n=(c=i.value)==null?void 0:c.columns[y])==null?void 0:n.df)==null?void 0:V.label;return(N=(S=i.value)==null?void 0:S.columns.filter(te=>te.header_title==w)[0])==null?void 0:N.column_number},f=()=>{ce("frappe.core.doctype.data_import.data_import.form_start_import",{data_import:x.data.name})},d=()=>{ce("frappe.core.doctype.data_import.data_import.get_import_logs",{data_import:x.data.name}).then(y=>{r.value=y,g.value=y})},l=()=>{u.value=="all"?g.value=r.value:u.value=="successful"?g.value=r.value.filter(y=>y.success):u.value=="failed"&&(g.value=r.value.filter(y=>!y.success))};ae(u,()=>{l()});const F=R(()=>r.value.length?r.value.filter(y=>y.success).length:0),C=R(()=>r.value.length?r.value.filter(y=>!y.success).length:0),M=R(()=>C.value==0?"bg-surface-green-2 text-ink-green-3":F.value==0?"bg-surface-red-2 text-ink-red-3":"bg-surface-amber-2 text-ink-amber-3"),p=R(()=>{var v,w;let y=[];return(w=(v=i.value)==null?void 0:v.warnings)!=null&&w.length?(i.value.warnings.forEach(B=>{if(B.type=="info"){const _=/<strong>(.*?)<\/strong>/g;let j;const c=[];for(;(j=_.exec(B.message))!==null;)c.push(j[1]);y.push(c)}}),y):[]}),o=R(()=>{var y,v;return((v=(y=i.value)==null?void 0:y.warnings)==null?void 0:v.filter(w=>w.type!="info"))||[]}),k=R(()=>{var y;return(y=x.doctypeMap[x.data.reference_doctype])==null?void 0:y.listRoute}),I=()=>{k.value&&(window.location.href=k.value)},ee=R(()=>{var y;return(y=x.doctypeMap[x.data.reference_doctype])==null?void 0:y.pageRoute}),ie=y=>{ee.value&&(window.location.href=ee.value.replace("docname",y))},de=R(()=>[{label:"All",value:"all"},{label:"Successful",value:"successful"},{label:"Failed",value:"failed"}]),se=y=>{var v,w;return(w=(v=JSON.parse(y.messages))==null?void 0:v[0])==null?void 0:w.message};return(y,v)=>{var w,B;return t(),m("div",dt,[e("div",ut,[e("div",ct,[e("div",pt,[v[2]||(v[2]=e("span",null," Review and Import ",-1)),$(ne,{theme:q(re)(h.data.status)},{default:A(()=>[X(D(h.data.status),1)]),_:1},8,["theme"])]),h.data.status!="Success"?(t(),P(W,{key:0,label:h.data.status!="Pending"?"Retry":"Import",variant:"solid",onClick:f},null,8,["label"])):k.value?(t(),P(W,{key:1,label:"Done",onClick:v[0]||(v[0]=_=>I())})):O("",!0)]),v[3]||(v[3]=e("div",{class:"leading-5 text-ink-gray-7"}," Verify the data before starting the import process ",-1))]),p.value.length?(t(),m("div",mt,[v[4]||(v[4]=e("div",{class:"text-ink-gray-5 text-sm"}," Column Mapping ",-1)),e("div",ft,[(t(!0),m(K,null,Q(p.value,_=>(t(),m("div",vt,[e("div",yt,D(_[0]),1),e("div",gt,[$(G,{name:"arrow-right",class:"inline size-4 text-ink-gray-5"})]),e("div",null,D(_[1]),1)]))),256))])])):O("",!0),o.value.length?(t(),m("div",xt,[v[5]||(v[5]=e("div",{class:"text-ink-gray-5 text-sm"}," Warnings ",-1)),e("div",_t,[(t(!0),m(K,null,Q(o.value,_=>(t(),m("div",bt,[$(G,{name:"alert-circle",class:"size-3 text-ink-amber-3"}),e("div",{innerHTML:_.message,class:"text-ink-amber-3"},null,8,ht)]))),256))])])):O("",!0),(B=(w=i.value)==null?void 0:w.data)!=null&&B.length?(t(),m("div",kt,[e("table",wt,[e("thead",St,[e("tr",null,[(t(!0),m(K,null,Q(L.value,_=>(t(),m("th",{key:_.key,style:me({minWidth:_.width,textAlign:_.align}),class:H(["p-2 text-left text-sm text-ink-gray-5",{"border-r":_.key!=L.value[L.value.length-1].key,"w-full":_.key==L.value[L.value.length-1].key}])},D(_.label),7))),128))])]),e("tbody",$t,[(t(!0),m(K,null,Q(z.value,(_,j)=>(t(),m("tr",{key:j},[(t(!0),m(K,null,Q(L.value,c=>(t(),m("td",{key:c.key,style:me({minWidth:c.width,textAlign:c.align}),class:H(["px-3 py-2 text-sm text-ink-gray-7 align-top",{"border-r":c.key!=L.value[L.value.length-1].key}])},[e("div",Ct,D(_[c.key]),1)],6))),128))]))),128))])])])):O("",!0),h.data.status!="Pending"&&r.value.length?(t(),m("div",It,[v[8]||(v[8]=e("div",{class:"font-semibold text-ink-gray-9"}," Import Logs ",-1)),e("div",{class:H(["rounded-md p-2",M.value])},D(F.value)+" "+D(F.value==1?"row":"rows")+" imported successfully, "+D(C.value)+" "+D(C.value==1?"row":"rows")+" failed. ",3),$(Pe,{buttons:de.value,modelValue:u.value,"onUpdate:modelValue":v[1]||(v[1]=_=>u.value=_),class:"w-fit"},null,8,["buttons","modelValue"]),g.value.length?(t(),m("div",Mt,[e("table",Ft,[v[7]||(v[7]=e("thead",{class:"rounded-t-md"},[e("tr",null,[e("th",{class:"p-2 text-left text-sm text-ink-gray-5 w-20 border-r text-center"}," Row no. "),e("th",{class:"p-2 text-left text-sm text-ink-gray-5 w-[80%]"}," Message ")])],-1)),e("tbody",Vt,[(t(!0),m(K,null,Q(g.value,(_,j)=>(t(),m("tr",{key:j,class:"group"},[e("td",Et,[e("div",Tt,[_.success?(t(),m("div",Nt)):(t(),m("div",Dt)),e("div",null,D(JSON.parse(_.row_indexes)[0]-1),1)])]),e("td",Ut,[se(_)?(t(),m("span",{key:0,innerHTML:se(_)},null,8,Rt)):!se(_)&&!_.success?(t(),m("span",Lt," Failed to import ")):_.success?(t(),m("span",jt,[v[6]||(v[6]=X(" Successfully imported ",-1)),e("span",{onClick:c=>ie(_.docname),class:H({"cursor-pointer underline":ee.value})},D(_.docname),11,Ot)])):O("",!0)]),e("td",Pt,[_.exception?(t(),P(Ie,{key:0,trigger:"hover",placement:"left-start"},{target:A(()=>[$(G,{name:"info",class:"size-4"})]),"body-main":A(()=>[e("div",zt,D(_.exception),1)]),_:2},1024)):O("",!0)])]))),128))])])])):(t(),m("div",Bt," No logs to display. "))])):O("",!0)])}}}),At={class:"text-base space-y-5"},Jt={class:"grid grid-cols-2 gap-5"},Ht={class:"border-t"},Wt={class:"space-x-2 mt-2 mb-5"},Gt={class:"space-y-8"},Kt={class:"text-ink-gray-5"},Qt={class:"grid grid-cols-2 gap-5"},Xt=["for"],Zt={class:"flex justify-end space-x-2"},Yt=Y({__name:"TemplateModal",props:Fe({doctype:{}},{modelValue:{type:Boolean,required:!0,default:!1},modelModifiers:{}}),emits:["update:modelValue"],setup(h){const T=Me(h,"modelValue"),i=E("CSV"),a=E("Blank Template"),r=E({}),g=E(null),u=h,x=_e({url:"frappe.desk.form.load.getdoctype",params:{doctype:u.doctype,with_parent:1},auto:!0,transform(p){return g.value=p.docs,U(p)}}),U=p=>{let o={};return L(p.docs,o),z(o),b(o),o},L=(p,o)=>{p.forEach(k=>{o[k.name]=k.fields.filter(I=>!oe.includes(I.fieldtype)).map(I=>({fieldname:I.fieldname,label:I.label,reqd:I.reqd,disabled:!!(k.name==u.doctype&&I.reqd)}))})},z=p=>{Object.keys(p).forEach(o=>{p[o].unshift({fieldname:"name",label:"ID",reqd:1})})},b=p=>{Object.keys(p).forEach(o=>{r.value[o]||(r.value[o]={},o==u.doctype&&p[o].forEach(k=>{k.reqd&&(r.value[o][k.fieldname]=!0)}))})},s=()=>{let p=u.doctype,o=d(),k=l(),I=a.value=="5 Records"?5:"";return`/api/method/frappe.core.doctype.data_import.data_import.download_template
        ?doctype=${encodeURIComponent(p)}
        &export_fields=${encodeURIComponent(JSON.stringify(o))}
        &export_records=${encodeURIComponent(k)}
        &file_type=${encodeURIComponent(i.value)}
        &export_page_length=${I}`.replace(/\s+/g,"")},f=async()=>{let p=s();const k=await(await fetch(p)).blob(),I=document.createElement("a");I.href=URL.createObjectURL(k),I.download=u.doctype+(i.value==="CSV"?".csv":".xlsx"),document.body.appendChild(I),I.click(),document.body.removeChild(I)},d=()=>{let p={};return Object.keys(r.value).forEach(o=>{let k=o==u.doctype?o:he(o,u.doctype,g.value);p[k]=Object.keys(r.value[o]).filter(I=>r.value[o][I])}),p},l=()=>a.value=="Blank Template"?"blank_template":a.value=="5 Records"?"5_records":"all",F=()=>{Object.keys(x.data).forEach(p=>{x.data[p].forEach(o=>{r.value[p]||(r.value[p]={}),r.value[p][o.fieldname]=!0})})},C=()=>{Object.keys(x.data).forEach(p=>{x.data[p].forEach(o=>{r.value[p][o.fieldname]=!!o.reqd})})},M=()=>{Object.keys(x.data).forEach(p=>{x.data[p].forEach(o=>{r.value[p][o.fieldname]=!1})})};return(p,o)=>(t(),P(xe,{modelValue:T.value,"onUpdate:modelValue":o[1]||(o[1]=k=>T.value=k),options:{title:"Export Data",size:"2xl"}},{"body-content":A(()=>[e("div",At,[e("div",Jt,[$(pe,{label:"File Type",modelValue:i.value,"onUpdate:modelValue":o[0]||(o[0]=k=>i.value=k),options:["Excel","CSV"],type:"select"},null,8,["modelValue"])]),e("div",Ht,[o[2]||(o[2]=e("p",{class:"mt-2 text-ink-gray-5"}," Select the fields you want to include in the template. ",-1)),e("div",Wt,[$(W,{label:"Select All",onClick:F}),$(W,{label:"Select Mandatory Fields",onClick:C}),$(W,{label:"Unselect All",onClick:M})]),e("div",Gt,[(t(!0),m(K,null,Q(Object.keys(q(x).data),k=>(t(),m("div",{key:k,class:"flex flex-col space-y-2"},[e("div",Kt,D(k),1),e("div",Qt,[(t(!0),m(K,null,Q(q(x).data[k],I=>(t(),m("div",{key:I.fieldname,class:"flex items-center space-x-2"},[$(Ve,{id:`checkbox-${k}-${I.fieldname}`,checked:r.value[k][I.fieldname],onChange:ee=>r.value[k][I.fieldname]=ee.target.checked},null,8,["id","checked","onChange"]),e("label",{for:`checkbox-${k}-${I.fieldname}`,class:H({"text-ink-red-3":I.reqd})},D(I.label||I.fieldname),11,Xt)]))),128))])]))),128))])])])]),actions:A(({close:k})=>[e("div",Zt,[$(W,{label:"Export",variant:"solid",onClick:f}),$(W,{label:"Cancel",onClick:k},null,8,["onClick"])])]),_:1},8,["modelValue"]))}}),ea={class:"text-base h-full flex flex-col w-[85%] lg:w-[700px] mx-auto pt-12 space-y-8"},ta={class:"flex flex-col space-y-1 text-ink-gray-7"},aa={class:"flex items-center justify-between"},sa={class:"flex items-center space-x-2 text-xl font-semibold text-ink-gray-9"},la={class:"space-y-4"},oa={key:0,class:"w-4/5 lg:w-2/5 text-center"},na={key:1,class:"w-4/5 lg:w-2/5 bg-surface-white border rounded-md p-2"},ra={class:"space-y-2"},ia={class:"font-medium"},da={class:"text-ink-gray-6"},ua={class:"w-full bg-surface-gray-1 h-1 rounded-full mt-3"},ca={key:1,class:"h-[300px] flex items-center justify-center bg-surface-gray-1 border border-dashed border-outline-gray-3 rounded-md"},pa={class:"w-4/5 lg:w-2/5 bg-surface-white border rounded-md p-2 flex items-center justify-between items-center"},ma={class:"space-y-2"},fa={class:"font-medium leading-5 text-ink-gray-9"},va={key:0,class:"text-ink-gray-6"},ya={key:2,class:"flex flex-col h-[300px] p-4 border border-dashed border-outline-gray-3 rounded-md"},ga={class:"flex items-center space-x-2 text-ink-gray-7"},xa={class:"flex-1 flex flex-col items-center justify-center w-[95%] lg:w-[400px] mx-auto space-y-3"},_a={class:"flex justify-end"},ba=Y({__name:"UploadStep",props:{dataImports:{},doctype:{},fields:{},data:{}},emits:["updateStep"],setup(h,{emit:T}){const i=T,a=E(null),r=E(""),g=E(!1),u=E(null),x=E(0),U=E(0),L=E(!1),z=E(null),b=E(!0),s=E(!1),f=E(!1),d=fe(),l=h,F=R(()=>U.value===0?0:Math.floor(x.value/U.value*100)),C=c=>{var S,N;const n=(S=c.target)==null?void 0:S.files,V=(N=c.dataTransfer)==null?void 0:N.files;return(n==null?void 0:n[0])||(V==null?void 0:V[0])||null},M=c=>{const n=C(c);if(!n)return;if(n.type!=="text/csv"){Z.error("Please upload a valid CSV file."),console.error("Please upload a valid CSV file.");return}u.value=n;const V=new De;V.on("start",()=>{g.value=!0}),V.on("progress",S=>{x.value=S.uploaded,U.value=S.total}),V.on("error",S=>{g.value=!1,Z.error(S),console.error("File upload error:",S)}),V.on("finish",()=>{g.value=!1}),V.upload(n,{}).then(S=>{a.value=S}).catch(S=>{console.error("File upload error:",S)})},p=()=>{var c;(c=l.data)!=null&&c.name?k():o()},o=()=>{var c;l.dataImports.insert.submit({reference_doctype:l.doctype,import_type:"Insert New Records",mute_emails:!0,status:"Pending",google_sheets_url:r.value.trim(),import_file:(c=a.value)==null?void 0:c.file_url},{onSuccess(n){d.replace({name:"DataImport",params:{importName:n.name},query:{step:"map"}})},onError(n){var V;Z.error(((V=n.messages)==null?void 0:V[0])||n),console.error("Error creating data import:",n)}})},k=()=>{l.data&&l.dataImports.setValue.submit({...l.data,google_sheets_url:r.value.trim(),import_file:a.value?a.value.file_url:""},{onSuccess(c){le(()=>{a.value||r.value.trim().length?i("updateStep","map",c):i("updateStep","upload",c)})},onError(c){var n;Z.error(((n=c.messages)==null?void 0:n[0])||c,{duration:1e3}),console.error("Error updating data import:",c)}})},I=async c=>{let n=ee(c);const S=await(await fetch(n)).blob(),N=document.createElement("a");N.href=URL.createObjectURL(S),N.download=l.doctype+".csv",document.body.appendChild(N),N.click(),document.body.removeChild(N)},ee=c=>{var V,S;if(!l.doctype&&!((V=l.data)!=null&&V.reference_doctype))return"";let n=ie(c);return`/api/method/frappe.core.doctype.data_import.data_import.download_template
        ?doctype=${encodeURIComponent(l.doctype||((S=l.data)==null?void 0:S.reference_doctype))}
        &export_fields=${encodeURIComponent(JSON.stringify(n))}
        &export_records=blank_template
        &file_type=CSV`.replace(/\s+/g,"")},ie=c=>c=="mandatory"?de():se(),de=()=>{var V,S;let n=((V=l.fields.data)==null?void 0:V.docs.find(N=>N.name==l.doctype)).fields.filter(N=>!oe.includes(N.fieldtype)&&N.reqd).map(N=>N.fieldname);return n.unshift("name"),{[l.doctype||((S=l.data)==null?void 0:S.reference_doctype)]:n}},se=()=>{var V;let c={},n=((V=l.fields.data)==null?void 0:V.docs)||[];return n.forEach(S=>{var J;let N=S.fields.filter(ue=>!oe.includes(ue.fieldtype)).map(ue=>ue.fieldname);N.unshift("name");let te=S.name==l.doctype?S.name:he(S.name,l.doctype||((J=l.data)==null?void 0:J.reference_doctype),n);c[te]=N}),c},y=()=>{var c;(c=z.value)==null||c.click()},v=()=>{b.value=!1,f.value=!1,s.value=!0},w=()=>{b.value=!0,f.value=!1,s.value=!1},B=R(()=>!a.value&&!r.value.trim().length);ae(()=>l.data,()=>{l.data&&(l.data.import_file?a.value=l.data.import_file:l.data.google_sheets_url&&(v(),r.value=l.data.google_sheets_url))},{immediate:!0}),ae([a,r],()=>{(!a.value||!r.value.trim().length)&&k()});const _=()=>{a.value=null},j=c=>(c/1024).toFixed(2)+" KB";return(c,n)=>{var V,S,N,te;return t(),m("div",ea,[e("div",ta,[e("div",aa,[e("div",sa,[n[5]||(n[5]=e("span",null," Choose Import ",-1)),(V=h.data)!=null&&V.status?(t(),P(ne,{key:0,theme:q(re)((S=h.data)==null?void 0:S.status)},{default:A(()=>{var J;return[X(D((J=h.data)==null?void 0:J.status),1)]}),_:1},8,["theme"])):O("",!0)]),$(W,{variant:"solid",onClick:p,disabled:B.value},{default:A(()=>[...n[6]||(n[6]=[X(" Continue ",-1)])]),_:1},8,["disabled"])]),n[7]||(n[7]=e("div",{class:"leading-5"}," Import data into your system using CSV files or Google Sheets. ",-1))]),e("div",la,[b.value&&!a.value?(t(),m("div",{key:0,onDragover:n[1]||(n[1]=ye(()=>{},["prevent"])),onDrop:n[2]||(n[2]=ye(J=>M(J),["prevent"])),class:"h-[300px] flex items-center justify-center bg-surface-gray-1 border border-dashed border-outline-gray-3 rounded-md"},[b.value&&!g.value?(t(),m("div",oa,[$(G,{name:"upload-cloud",class:"size-6 stroke-1.5 text-ink-gray-6 mx-auto mb-2.5"}),e("input",{ref_key:"fileInput",ref:z,type:"file",accept:".csv",class:"hidden",onChange:n[0]||(n[0]=J=>M(J))},null,544),e("div",{class:"leading-5 text-ink-gray-9"},[n[8]||(n[8]=X(" Drag and drop a CSV file, or upload from your ",-1)),e("span",{onClick:y,class:"cursor-pointer font-semibold hover:underline"},"Device"),n[9]||(n[9]=X(" or ",-1)),e("span",{onClick:v,class:"cursor-pointer font-semibold hover:underline"}," Google Sheet ")])])):b.value&&g.value?(t(),m("div",na,[e("div",ra,[e("div",ia,D(u.value.name),1),e("div",da,D(j(x.value))+" of "+D(j(U.value)),1)]),e("div",ua,[e("div",{class:"bg-surface-gray-7 h-1 rounded-full transition-all duration-500 ease-in-out",style:me(`width: ${F.value}%`)},null,4)])])):O("",!0)],32)):a.value?(t(),m("div",ca,[e("div",pa,[e("div",ma,[e("div",fa,D(a.value.file_name||a.value.split("/").pop()),1),a.value.file_size?(t(),m("div",va,D(j(a.value.file_size)),1)):O("",!0)]),$(G,{name:"trash-2",class:"size-4 stroke-1.5 text-ink-red-3 cursor-pointer",onClick:_})])])):s.value?(t(),m("div",ya,[e("div",ga,[$(G,{name:"chevron-left",class:"size-4 cursor-pointer",onClick:w}),n[10]||(n[10]=e("div",null," Google Sheet ",-1))]),e("div",xa,[Ee(e("input",{"onUpdate:modelValue":n[3]||(n[3]=J=>r.value=J),type:"text",class:"w-full border border-outline-gray-2 rounded-md px-2.5 text-base",placeholder:"Add Google Sheets Link"},null,512),[[Te,r.value]]),n[11]||(n[11]=e("div",{class:"text-ink-gray-5"}," Make sure the link is publically accessible to fetch the data. ",-1))])])):O("",!0),e("div",_a,[$(Ne,{options:[{label:"Mandatory Fields",onClick(){I("mandatory")}},{label:"All Fields",onClick(){I("all")}},{label:"Custom Template",onClick(){L.value=!0}}]},{default:A(({open:J})=>[$(W,{variant:"ghost"},{prefix:A(()=>[$(G,{name:"download",class:"size-4 stroke-1.5"})]),suffix:A(()=>[$(G,{name:"chevron-down",class:H(["w-4 h-4 stroke-1.5 ml-1 transform transition-transform",J?"rotate-180":""])},null,8,["class"])]),default:A(()=>[n[12]||(n[12]=X(" Download CSV Template ",-1))]),_:2},1024)]),_:1},8,["options"])])]),l.doctype||(N=l.data)!=null&&N.reference_doctype?(t(),P(Yt,{key:0,modelValue:L.value,"onUpdate:modelValue":n[4]||(n[4]=J=>L.value=J),doctype:l.doctype||((te=l.data)==null?void 0:te.reference_doctype)},null,8,["modelValue","doctype"])):O("",!0)])}}}),ha={class:"sticky flex items-center justify-between space-x-28 top-0 z-10 border-b bg-surface-white px-3 py-2.5 sm:px-5"},ka=Y({__name:"DataImport",props:{label:{},description:{},doctype:{},importName:{},doctypeMap:{}},setup(h){const T=be(),i=E("list"),a=E(null),r=h,g=Ue({doctype:"Data Import",fields:["name","reference_doctype","import_type","status","creation","mute_emails","import_file","google_sheets_url","template_options"],auto:!0,orderBy:"modified desc"}),u=_e({url:"frappe.desk.form.load.getdoctype",makeParams:b=>({doctype:b.doctype,with_parent:1}),auto:!1}),x=()=>{var b;a.value=((b=g.data)==null?void 0:b.find(s=>s.name===r.importName))||null};ae(()=>[T.params,r,g.data],()=>{var b,s,f,d;r.doctype?(i.value="upload",u.reload({doctype:T.params.doctype})):r.importName&&(x(),!((b=a.value)!=null&&b.import_file)&&!((s=a.value)!=null&&s.google_sheets_url)?i.value="upload":i.value=="upload"&&T.query.step=="map"?i.value=T.query.step:i.value="preview",(f=a.value)!=null&&f.reference_doctype&&u.reload({doctype:(d=a.value)==null?void 0:d.reference_doctype}))},{immediate:!0}),ae(()=>T.query,()=>{T.query.step=="list"&&(i.value="list")});const U=(b,s)=>{i.value=b,s&&(a.value=s)},L=R(()=>{var s,f,d;let b=r.doctype||((s=a.value)==null?void 0:s.reference_doctype);return((d=(f=r.doctypeMap)==null?void 0:f[b||""])==null?void 0:d.title)||b||""}),z=R(()=>{let b=[{label:"Data Import",route:{name:"DataImportList",query:{step:"list"}}}];return i.value!=="list"&&b.push({label:`Importing ${L.value}`}),b});return(b,s)=>{var f;return t(),m(K,null,[e("header",ha,[$(Oe,{items:z.value},null,8,["items"]),i.value!="list"?(t(),P(ge,{key:0,class:"flex-1 hidden lg:flex",data:a.value,step:i.value,onUpdateStep:U},null,8,["data","step"])):O("",!0)]),e("div",null,[i.value!="list"?(t(),P(ge,{key:0,class:"flex-1 lg:hidden w-[90%] mx-auto mt-5",data:a.value,step:i.value,onUpdateStep:U},null,8,["data","step"])):O("",!0),i.value==="list"?(t(),P(Ze,{key:1,dataImports:q(g),onUpdateStep:U},null,8,["dataImports"])):i.value==="upload"?(t(),P(ba,{key:2,dataImports:q(g),doctype:h.doctype||((f=a.value)==null?void 0:f.reference_doctype),fields:q(u),data:a.value,onUpdateStep:U},null,8,["dataImports","doctype","fields","data"])):i.value==="map"?(t(),P(it,{key:3,dataImports:q(g),data:a.value,fields:q(u),onUpdateStep:U},null,8,["dataImports","data","fields"])):i.value==="preview"?(t(),P(qt,{key:4,dataImports:q(g),data:a.value,fields:q(u),doctypeMap:h.doctypeMap,onUpdateStep:U},null,8,["dataImports","data","fields","doctypeMap"])):O("",!0)])],64)}}}),Ca=Y({__name:"DataImport",setup(h){const{brand:T}=Re(),i=be(),a=fe(),r=je("$user");ve(()=>{var u;(u=r.data)!=null&&u.is_moderator||a.push({name:"Courses"})});const g={"LMS Course":{title:"Courses",listRoute:"/courses",pageRoute:"/courses/docname"},"LMS Batch":{title:"Batches",listRoute:"/batches"},"LMS Category":{title:"Categories",listRoute:"/lms"}};return Le(()=>({title:__("Data Import"),icon:T.favicon})),(u,x)=>(t(),P(q(ka),{doctype:q(i).params.doctype,importName:q(i).params.importName,doctypeMap:g},null,8,["doctype","importName"]))}});export{Ca as default};
//# sourceMappingURL=DataImport-CMYk1Jkf.js.map
