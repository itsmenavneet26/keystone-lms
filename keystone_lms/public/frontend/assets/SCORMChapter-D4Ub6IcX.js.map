{"version":3,"file":"SCORMChapter-D4Ub6IcX.js","sources":["../../../../frontend/src/pages/SCORMChapter.vue"],"sourcesContent":["<template>\n\t<header\n\t\tclass=\"sticky top-0 z-10 flex items-center justify-between border-b bg-surface-white px-3 py-2.5 sm:px-5\"\n\t>\n\t\t<Breadcrumbs class=\"h-7\" :items=\"breadcrumbs\" />\n\t</header>\n\t<div\n\t\tv-if=\"\n\t\t\treadyToRender &&\n\t\t\t(enrollment.data?.length ||\n\t\t\t\tuser.data?.is_moderator ||\n\t\t\t\tuser.data?.is_instructor)\n\t\t\"\n\t>\n\t\t<iframe\n\t\t\t:src=\"chapter.doc.launch_file\"\n\t\t\tclass=\"w-full h-[calc(100vh-3.00rem)]\"\n\t\t/>\n\t</div>\n\t<div v-else-if=\"!enrollment.data?.length\">\n\t\t<div class=\"text-center pt-10 px-5 md:px-0 pb-10\">\n\t\t\t<div class=\"text-center\">\n\t\t\t\t<div class=\"mb-4\">\n\t\t\t\t\t{{\n\t\t\t\t\t\t__(\n\t\t\t\t\t\t\t'You are not enrolled in this course. Please enroll to access this lesson.'\n\t\t\t\t\t\t)\n\t\t\t\t\t}}\n\t\t\t\t</div>\n\t\t\t\t<Button variant=\"solid\" @click=\"enrollStudent()\">\n\t\t\t\t\t{{ __('Start Learning') }}\n\t\t\t\t</Button>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</template>\n<script setup>\nimport {\n\tBreadcrumbs,\n\tButton,\n\tcall,\n\tcreateDocumentResource,\n\tcreateListResource,\n\tcreateResource,\n\tusePageMeta,\n} from 'frappe-ui'\nimport { computed, inject, onBeforeMount, ref } from 'vue'\nimport { useSidebar } from '@/stores/sidebar'\nimport { sessionStore } from '../stores/session'\n\nconst { brand } = sessionStore()\nconst sidebarStore = useSidebar()\nconst user = inject('$user')\nconst readyToRender = ref(false)\nconst isSuccessfullyCompleted = ref(false)\n\n// If courseRestartOnFailure is true, student has to restart the whole course if failed.\n// Otherwise, student could retake the final quiz portion.\n// Ideally, this should be configurable along with `Number of failures before course should restart`.\nconst courseRestartOnFailure = false\n\nconst props = defineProps({\n\tcourseName: {\n\t\ttype: String,\n\t\trequired: true,\n\t},\n\tchapterName: {\n\t\ttype: String,\n\t\trequired: true,\n\t},\n})\n\nonBeforeMount(() => {\n\tsidebarStore.isSidebarCollapsed = true\n\tsetupSCORMAPI()\n})\n\nconst chapter = createDocumentResource({\n\tdoctype: 'Course Chapter',\n\tname: props.chapterName,\n\tauto: true,\n\tcache: ['chapter', props.chapterName],\n\tonSuccess(data) {\n\t\tprogress.submit()\n\t},\n})\n\nconst enrollment = createListResource({\n\tdoctype: 'LMS Enrollment',\n\tfields: ['member', 'course'],\n\tfilters: {\n\t\tcourse: props.courseName,\n\t\tmember: user.data?.name,\n\t},\n\tauto: true,\n\tcache: ['enrollments', props.courseName, user.data?.name],\n})\n\nconst getDataFromLMS = (key) => {\n\tif (key === 'cmi.core.lesson_status') {\n\t\treturn progress.data?.status === 'Complete' ? 'passed' : 'incomplete'\n\t} else if (key === 'cmi.launch_data') {\n\t\treturn progress.data?.scorm_content || ''\n\t} else if (key === 'cmi.suspend_data') {\n\t\treturn progress.data?.scorm_content || ''\n\t}\n\treturn ''\n}\n\nlet saveTimeout = null\nconst debouncedSaveProgress = (scormDetails) => {\n\tclearTimeout(saveTimeout)\n\tsaveTimeout = setTimeout(() => {\n\t\tsaveProgress(scormDetails)\n\t}, 300)\n}\n\nconst saveDataToLMS = (key, value) => {\n\tconst isLessonStatus = key === 'cmi.core.lesson_status' && value === 'passed'\n\tconst isCompletionStatus =\n\t\tkey === 'cmi.completion_status' && value === 'completed'\n\tconst shouldRestart =\n\t\t(key === 'cmi.core.lesson_status' && value === 'failed') ||\n\t\t(key === 'cmi.completion_status' && value === 'incomplete')\n\n\tif (isLessonStatus || isCompletionStatus) {\n\t\tisSuccessfullyCompleted.value = true\n\t}\n\n\tif (\n\t\tisLessonStatus ||\n\t\tisCompletionStatus ||\n\t\t(shouldRestart && courseRestartOnFailure)\n\t) {\n\t\tsaveProgress({\n\t\t\tis_complete: isSuccessfullyCompleted.value,\n\t\t\tscorm_content: '',\n\t\t})\n\t\treturn\n\t}\n\n\tif (key === 'cmi.suspend_data' && !isSuccessfullyCompleted.value) {\n\t\tdebouncedSaveProgress({\n\t\t\tis_complete: false,\n\t\t\tscorm_content: value,\n\t\t})\n\t}\n}\n\nconst saveProgress = (scormDetails = null) => {\n\tcall('lms.lms.doctype.course_lesson.course_lesson.save_progress', {\n\t\tlesson: chapter.doc.lessons[0].lesson,\n\t\tcourse: props.courseName,\n\t\tscorm_details: scormDetails,\n\t})\n}\n\nconst progress = createResource({\n\turl: 'frappe.client.get_value',\n\tmakeParams(values) {\n\t\treturn {\n\t\t\tdoctype: 'LMS Course Progress',\n\t\t\tfieldname: ['status', 'scorm_content'],\n\t\t\tfilters: {\n\t\t\t\tmember: user.data?.name,\n\t\t\t\tlesson: chapter.doc.lessons[0].lesson,\n\t\t\t\tchapter: chapter.doc.name,\n\t\t\t\tcourse: chapter.doc?.course,\n\t\t\t},\n\t\t}\n\t},\n\tonSuccess(data) {\n\t\treadyToRender.value = true\n\t},\n})\n\nconst enrollStudent = () => {\n\tenrollment.insert.submit(\n\t\t{\n\t\t\tcourse: props.courseName,\n\t\t\tmember: user.data?.name,\n\t\t},\n\t\t{\n\t\t\tonSuccess(data) {\n\t\t\t\twindow.location.reload()\n\t\t\t},\n\t\t}\n\t)\n}\n\nconst setupSCORMAPI = () => {\n\twindow.API_1484_11 = {\n\t\tInitialize: () => 'true',\n\t\tTerminate: () => 'true',\n\t\tGetValue: (key) => {\n\t\t\tconsole.log(`GET: ${key}`)\n\t\t\treturn getDataFromLMS(key)\n\t\t},\n\t\tSetValue: (key, value) => {\n\t\t\tconsole.log(`SET: ${key} to value: ${value}`)\n\n\t\t\tsaveDataToLMS(key, value)\n\t\t\treturn 'true'\n\t\t},\n\t\tCommit: () => 'true',\n\t\tGetLastError: () => '0',\n\t\tGetErrorString: () => '',\n\t\tGetDiagnostic: () => '',\n\t}\n\twindow.API = {\n\t\tLMSInitialize: () => 'true',\n\t\tLMSFinish: () => 'true',\n\t\tLMSGetValue: (key) => {\n\t\t\tconsole.log(`GET: ${key}`)\n\t\t\treturn getDataFromLMS(key)\n\t\t},\n\t\tLMSSetValue: (key, value) => {\n\t\t\tconsole.log(`SET: ${key} to value: ${value}`)\n\t\t\tsaveDataToLMS(key, value)\n\t\t\treturn 'true'\n\t\t},\n\t\tLMSCommit: () => 'true',\n\t\tLMSGetLastError: () => '0',\n\t\tLMSGetErrorString: () => '',\n\t\tLMSGetDiagnostic: () => '',\n\t}\n}\n\nconst breadcrumbs = computed(() => {\n\treturn [\n\t\t{\n\t\t\tlabel: __('Courses'),\n\t\t\troute: { name: 'Courses' },\n\t\t},\n\t\t{\n\t\t\tlabel: chapter.doc?.course_title,\n\t\t\troute: { name: 'CourseDetail', params: { courseName: props.courseName } },\n\t\t},\n\t\t{\n\t\t\tlabel: chapter.doc?.title,\n\t\t},\n\t]\n})\n\nusePageMeta(() => {\n\treturn {\n\t\ttitle: chapter.doc?.title,\n\t\ticon: brand.favicon,\n\t}\n})\n</script>\n"],"names":["courseRestartOnFailure","brand","sessionStore","sidebarStore","useSidebar","user","inject","readyToRender","ref","isSuccessfullyCompleted","props","__props","onBeforeMount","setupSCORMAPI","chapter","createDocumentResource","data","progress","enrollment","createListResource","_a","_b","getDataFromLMS","key","_c","saveTimeout","debouncedSaveProgress","scormDetails","saveProgress","saveDataToLMS","value","isLessonStatus","isCompletionStatus","shouldRestart","call","createResource","values","enrollStudent","breadcrumbs","computed","usePageMeta","_createElementVNode","_hoisted_1","_createVNode","_unref","Breadcrumbs","_createElementBlock","_hoisted_2","_hoisted_4","_hoisted_5","_hoisted_6","_hoisted_7","_toDisplayString","__","Button"],"mappings":"8fA2DMA,GAAyB,iIAT/B,KAAM,CAAE,MAAAC,CAAK,EAAKC,EAAY,EACxBC,EAAeC,EAAU,EACzBC,EAAOC,EAAO,OAAO,EACrBC,EAAgBC,EAAI,EAAK,EACzBC,EAA0BD,EAAI,EAAK,EAOnCE,EAAQC,EAWdC,EAAc,IAAM,CACnBT,EAAa,mBAAqB,GAClCU,EAAa,CACd,CAAC,EAED,MAAMC,EAAUC,EAAuB,CACtC,QAAS,iBACT,KAAML,EAAM,YACZ,KAAM,GACN,MAAO,CAAC,UAAWA,EAAM,WAAW,EACpC,UAAUM,EAAM,CACfC,EAAS,OAAM,CAChB,CACD,CAAC,EAEKC,EAAaC,EAAmB,CACrC,QAAS,iBACT,OAAQ,CAAC,SAAU,QAAQ,EAC3B,QAAS,CACR,OAAQT,EAAM,WACd,QAAQU,EAAAf,EAAK,OAAL,YAAAe,EAAW,IACrB,EACC,KAAM,GACN,MAAO,CAAC,cAAeV,EAAM,YAAYW,EAAAhB,EAAK,OAAL,YAAAgB,EAAW,IAAI,CACzD,CAAC,EAEKC,EAAkBC,GAAQ,WAC/B,OAAIA,IAAQ,2BACJH,EAAAH,EAAS,OAAT,YAAAG,EAAe,UAAW,WAAa,SAAW,aAC/CG,IAAQ,oBACXF,EAAAJ,EAAS,OAAT,YAAAI,EAAe,gBAAiB,GAC7BE,IAAQ,sBACXC,EAAAP,EAAS,OAAT,YAAAO,EAAe,gBAAiB,EAGzC,EAEA,IAAIC,EAAc,KAClB,MAAMC,EAAyBC,GAAiB,CAC/C,aAAaF,CAAW,EACxBA,EAAc,WAAW,IAAM,CAC9BG,EAAaD,CAAY,CAC1B,EAAG,GAAG,CACP,EAEME,EAAgB,CAACN,EAAKO,IAAU,CACrC,MAAMC,EAAiBR,IAAQ,0BAA4BO,IAAU,SAC/DE,EACLT,IAAQ,yBAA2BO,IAAU,YACxCG,EACJV,IAAQ,0BAA4BO,IAAU,UAC9CP,IAAQ,yBAA2BO,IAAU,aAM/C,IAJIC,GAAkBC,KACrBvB,EAAwB,MAAQ,IAIhCsB,GACAC,GACCC,GAAiBjC,GACjB,CACD4B,EAAa,CACZ,YAAanB,EAAwB,MACrC,cAAe,EAClB,CAAG,EACD,MACD,CAEIc,IAAQ,oBAAsB,CAACd,EAAwB,OAC1DiB,EAAsB,CACrB,YAAa,GACb,cAAeI,CAClB,CAAG,CAEH,EAEMF,EAAe,CAACD,EAAe,OAAS,CAC7CO,EAAK,4DAA6D,CACjE,OAAQpB,EAAQ,IAAI,QAAQ,CAAC,EAAE,OAC/B,OAAQJ,EAAM,WACd,cAAeiB,CACjB,CAAE,CACF,EAEMV,EAAWkB,EAAe,CAC/B,IAAK,0BACL,WAAWC,EAAQ,SAClB,MAAO,CACN,QAAS,sBACT,UAAW,CAAC,SAAU,eAAe,EACrC,QAAS,CACR,QAAQhB,EAAAf,EAAK,OAAL,YAAAe,EAAW,KACnB,OAAQN,EAAQ,IAAI,QAAQ,CAAC,EAAE,OAC/B,QAASA,EAAQ,IAAI,KACrB,QAAQO,EAAAP,EAAQ,MAAR,YAAAO,EAAa,MACzB,CACA,CACC,EACA,UAAUL,EAAM,CACfT,EAAc,MAAQ,EACvB,CACD,CAAC,EAEK8B,EAAgB,IAAM,OAC3BnB,EAAW,OAAO,OACjB,CACC,OAAQR,EAAM,WACd,QAAQU,EAAAf,EAAK,OAAL,YAAAe,EAAW,IACtB,EACE,CACC,UAAUJ,EAAM,CACf,OAAO,SAAS,OAAM,CACvB,CACH,CACA,CACA,EAEMH,EAAgB,IAAM,CAC3B,OAAO,YAAc,CACpB,WAAY,IAAM,OAClB,UAAW,IAAM,OACjB,SAAWU,IACV,QAAQ,IAAI,QAAQA,CAAG,EAAE,EAClBD,EAAeC,CAAG,GAE1B,SAAU,CAACA,EAAKO,KACf,QAAQ,IAAI,QAAQP,CAAG,cAAcO,CAAK,EAAE,EAE5CD,EAAcN,EAAKO,CAAK,EACjB,QAER,OAAQ,IAAM,OACd,aAAc,IAAM,IACpB,eAAgB,IAAM,GACtB,cAAe,IAAM,EACvB,EACC,OAAO,IAAM,CACZ,cAAe,IAAM,OACrB,UAAW,IAAM,OACjB,YAAcP,IACb,QAAQ,IAAI,QAAQA,CAAG,EAAE,EAClBD,EAAeC,CAAG,GAE1B,YAAa,CAACA,EAAKO,KAClB,QAAQ,IAAI,QAAQP,CAAG,cAAcO,CAAK,EAAE,EAC5CD,EAAcN,EAAKO,CAAK,EACjB,QAER,UAAW,IAAM,OACjB,gBAAiB,IAAM,IACvB,kBAAmB,IAAM,GACzB,iBAAkB,IAAM,EAC1B,CACA,EAEMQ,EAAcC,EAAS,IAAM,SAClC,MAAO,CACN,CACC,MAAO,GAAG,SAAS,EACnB,MAAO,CAAE,KAAM,SAAS,CAC3B,EACE,CACC,OAAOnB,EAAAN,EAAQ,MAAR,YAAAM,EAAa,aACpB,MAAO,CAAE,KAAM,eAAgB,OAAQ,CAAE,WAAYV,EAAM,WAAY,CAC1E,EACE,CACC,OAAOW,EAAAP,EAAQ,MAAR,YAAAO,EAAa,KACvB,CACA,CACA,CAAC,EAED,OAAAmB,EAAY,IAAM,OACjB,MAAO,CACN,OAAOpB,EAAAN,EAAQ,MAAR,YAAAM,EAAa,MACpB,KAAMnB,EAAM,OACd,CACA,CAAC,2CAxPAwC,EAIS,SAJTC,EAIS,CADRC,EAAgDC,EAAAC,CAAA,EAAA,CAAnC,MAAM,MAAO,MAAOP,EAAA,2BAGvB/B,EAAA,SAAqBqC,EAAAA,EAAA1B,CAAA,EAAW,OAAX0B,MAAAA,EAAiB,SAAcA,EAAAA,EAAAvC,CAAA,EAAK,OAALuC,MAAAA,EAAW,eAAoBA,EAAAA,EAAAvC,CAAA,EAAK,OAALuC,MAAAA,EAAW,oBADzGE,EAYM,MAAAC,EAAA,CAJLN,EAGE,SAAA,CAFA,IAAKG,EAAA9B,CAAA,EAAQ,IAAI,YAClB,MAAM,gDAGS8B,EAAAA,EAAA1B,CAAA,EAAW,OAAX0B,MAAAA,EAAiB,qBAAlCE,EAeM,MAAAE,EAAA,CAdLP,EAaM,MAbNQ,EAaM,CAZLR,EAWM,MAXNS,GAWM,CAVLT,EAMM,MANNU,GAMMC,EAJJC,EAAAA,oFAKFV,EAESC,EAAAU,CAAA,EAAA,CAFD,QAAQ,QAAS,wBAAOjB,iBAC/B,IAA0B,KAAvBgB,EAAAA,GAAE,gBAAA,CAAA,EAAA,CAAA"}